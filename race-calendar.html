<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Calendar â€” Let's Talk Running</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- NAV -->
<nav class="navbar">
    <a href="index.html" class="nav-brand">
        <span class="brand-icon">ğŸƒ</span>
        Let's Talk <span class="brand-accent">&nbsp;Running</span>
    </a>
    <ul class="nav-menu">
        <li><a href="index.html" class="nav-link">Home</a></li>
        <li><a href="about.html" class="nav-link">About Us</a></li>
        <li><a href="coaching.html" class="nav-link">Coaching Plans</a></li>
        <li><a href="race-calendar.html" class="nav-link active">Race Calendar</a></li>
    </ul>
</nav>

<!-- PAGE HERO -->
<section class="page-hero">
    <div class="eyebrow">Live Data Â· Auto-Updated</div>
    <h1>Race Calendar</h1>
    <p>Upcoming running events across India â€” sourced live from indiarunning.com, bhaagoindia.com, townscript.com, mysamay.in, citywoofer.com &amp; BookMyShow.</p>
</section>

<!-- CALENDAR -->
<section class="section">
    <div class="container">

        <!-- FILTERS -->
        <div class="calendar-filters">
            <span class="filter-label">Region:</span>
            <button class="filter-chip active" data-group="region" data-value="all">All</button>
            <button class="filter-chip" data-group="region" data-value="india">India</button>

            <span class="filter-label" style="margin-left:1rem;">Distance:</span>
            <button class="filter-chip active" data-group="distance" data-value="all">All</button>
            <button class="filter-chip" data-group="distance" data-value="5k">5K</button>
            <button class="filter-chip" data-group="distance" data-value="10k">10K</button>
            <button class="filter-chip" data-group="distance" data-value="half">Half Marathon</button>
            <button class="filter-chip" data-group="distance" data-value="marathon">Full Marathon</button>
            <button class="filter-chip" data-group="distance" data-value="ultra">Ultra</button>

            <select class="filter-select" id="month-select" style="margin-left:auto;">
                <option value="all">All Months</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>

        <!-- STATUS BAR -->
        <div class="calendar-status">
            <span id="api-status"><span class="status-dot"></span>Loading eventsâ€¦</span>
            <span id="filtered-count" style="color:var(--text-muted);"></span>
            <button class="btn-refresh" id="refresh-btn">
                <span class="refresh-icon">â†»</span> Refresh
            </button>
        </div>

        <!-- EVENT LIST (populated by JS) -->
        <div id="events-container">
            <!-- skeleton -->
            <div class="skeleton-card">
                <div class="skeleton-block" style="width:58px;height:72px;border-radius:8px;flex-shrink:0;"></div>
                <div style="flex:1;">
                    <div class="skeleton-block" style="height:16px;width:55%;margin-bottom:10px;"></div>
                    <div class="skeleton-block" style="height:12px;width:35%;"></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton-block" style="width:58px;height:72px;border-radius:8px;flex-shrink:0;"></div>
                <div style="flex:1;">
                    <div class="skeleton-block" style="height:16px;width:65%;margin-bottom:10px;"></div>
                    <div class="skeleton-block" style="height:12px;width:40%;"></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton-block" style="width:58px;height:72px;border-radius:8px;flex-shrink:0;"></div>
                <div style="flex:1;">
                    <div class="skeleton-block" style="height:16px;width:48%;margin-bottom:10px;"></div>
                    <div class="skeleton-block" style="height:12px;width:30%;"></div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- FOOTER -->
<footer>
    <div class="footer-inner">
        <div class="footer-top">
            <div class="footer-brand">
                <div class="brand">ğŸƒ Let's Talk Running</div>
                <p>A community platform for runners at every level â€” from first 5K to ultra finish lines.</p>
            </div>
            <div class="footer-col">
                <h4>Pages</h4>
                <ul>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="coaching.html">Coaching Plans</a></li>
                    <li><a href="race-calendar.html">Race Calendar</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">&copy; 2025 Let's Talk Running. All rights reserved.</div>
    </div>
</footer>

<script src="js/main.js"></script>
<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allEvents = [];
let filters   = { region: 'all', distance: 'all', month: 'all' };

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    loadEvents();

    // Filter chip clicks
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const group = chip.dataset.group;
            document.querySelectorAll(`.filter-chip[data-group="${group}"]`)
                    .forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            filters[group] = chip.dataset.value;
            renderEvents();
        });
    });

    // Month select
    document.getElementById('month-select').addEventListener('change', e => {
        filters.month = e.target.value;
        renderEvents();
    });

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', async () => {
        const btn = document.getElementById('refresh-btn');
        btn.classList.add('spinning');
        btn.disabled = true;
        try {
            await fetch('/api/refresh', { method: 'POST' });
            await loadEvents();
        } catch (_) {}
        btn.classList.remove('spinning');
        btn.disabled = false;
    });
});

// â”€â”€â”€ Load events from API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEvents() {
    try {
        const res  = await fetch('/api/events?_t=' + Date.now(), { cache: 'no-cache' });
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        allEvents = data.events || [];
        updateStatusBar(data.total, data.fetchedAt, data.stale);
        renderEvents();

    } catch (err) {
        console.error('loadEvents error:', err);
        showError('Could not load events. Make sure the backend server is running.');
    }
}

// â”€â”€â”€ Render filtered list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEvents() {
    const container = document.getElementById('events-container');
    const list      = clientFilter(allEvents);

    document.getElementById('filtered-count').textContent =
        list.length > 0 ? `${list.length} event${list.length !== 1 ? 's' : ''} shown` : '';

    if (list.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <span class="empty-icon">ğŸ”</span>
                <h3>No events match your filters</h3>
                <p>Try selecting a different distance, region, or month.</p>
            </div>`;
        return;
    }

    container.innerHTML = `<div class="events-list">${list.map(eventCard).join('')}</div>`;
}

// â”€â”€â”€ Client-side filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clientFilter(events) {
    return events.filter(e => {
        // Region
        if (filters.region === 'india'  && e.region !== 'India') return false;
        if (filters.region === 'global' && e.region === 'India')  return false;

        // Distance
        if (filters.distance !== 'all') {
            const match = (e.distances || []).some(d => clientDistanceMatch(d, filters.distance));
            if (!match) return false;
        }

        // Month
        if (filters.month !== 'all') {
            const m = new Date(e.startDate).getMonth() + 1;
            if (m !== parseInt(filters.month)) return false;
        }

        return true;
    });
}

function clientDistanceMatch(label, filter) {
    const d = (label || '').toLowerCase();
    switch (filter) {
        case '5k':       return d.includes('5k') || d === '5';
        case '10k':      return d.includes('10k') || d === '10';
        case 'half':     return d.includes('half') || d.includes('21');
        case 'marathon': return d.includes('marathon') && !d.includes('half') && !d.includes('ultra');
        case 'ultra':    return d.includes('ultra') || /\b(50|60|100)\b/.test(d);
        default:         return true;
    }
}

// â”€â”€â”€ Event card HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eventCard(ev) {
    const date  = new Date(ev.startDate);
    const day   = date.getDate();
    const month = date.toLocaleString('en-IN', { month: 'short' }).toUpperCase();
    const year  = date.getFullYear();

    const location = [ev.city, ev.state].filter(Boolean).join(', ') || 'India';

    const distTags = (ev.distances || []).map(d =>
        `<span class="tag tag-primary" style="font-size:0.72rem;">${esc(d)}</span>`
    ).join('');

    const priceHtml = ev.price
        ? `<span class="event-price">Â· ${esc(ev.price)}</span>`
        : '';

    return `
    <div class="event-card">
        <div class="event-date">
            <span class="day">${day}</span>
            <span class="month">${month}</span>
            <span class="year">${year}</span>
        </div>
        <div class="event-info">
            <div class="event-title">${esc(ev.title)}</div>
            <div class="event-meta">
                <span class="event-location">ğŸ“ ${esc(location)}</span>
                <div class="event-distances">${distTags}</div>
                ${priceHtml}
                <span class="event-source">via ${esc(ev.source)}</span>
            </div>
        </div>
        <div class="event-actions">
            <a href="${esc(ev.url)}" class="btn btn-outline" target="_blank" rel="noopener noreferrer"
               style="padding:0.5rem 1rem;font-size:0.85rem;">
                Details â†’
            </a>
        </div>
    </div>`;
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
}

function updateStatusBar(total, fetchedAt, stale) {
    const time  = fetchedAt ? new Date(fetchedAt).toLocaleString('en-IN') : 'â€”';
    const extra = stale ? ' Â· <em>cached data</em>' : '';
    document.getElementById('api-status').innerHTML =
        `<span class="status-dot"></span> ${total} events loaded Â· Updated: ${time}${extra}`;
}

function showError(msg) {
    document.getElementById('events-container').innerHTML = `
        <div class="empty-state">
            <span class="empty-icon">âš ï¸</span>
            <h3>Could not load events</h3>
            <p>${msg}</p>
        </div>`;
    document.getElementById('api-status').textContent = 'âš ï¸ Connection error';
}
</script>
</body>
</html>
